# ============================================================================
# GitHub Actions Workflow: Generate & Publish Java SDKs
#
# Directory Convention:
# services/{service-name}/{service-name}-openapi.yaml
#
# Responsibilities:
# - Detect changed OpenAPI specs
# - Generate Java SDKs (8 / 17 / 21)
# - Apply post-generation fixes via shell scripts
# - Publish artifacts to GitHub Packages
# ============================================================================

name: Generate & Publish Java SDKs

# ----------------------------------------------------------------------------
# Triggers
# ----------------------------------------------------------------------------
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    # Required for publishing to GitHub Packages
    permissions:
      contents: write
      packages: write

    steps:
      # ======================================================================
      # STEP 1: Checkout repository
      # fetch-depth=2 is REQUIRED for git diff
      # ======================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ======================================================================
      # STEP 2: Setup Java (used for Maven build + deploy)
      # ======================================================================
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      # ======================================================================
      # STEP 3: Install OpenAPI Generator
      # ======================================================================
      - name: Install OpenAPI Generator CLI
        run: |
          npm install -g @openapitools/openapi-generator-cli
          npm install -g @apidevtools/swagger-cli
          npm install -g openapi-diff

      # ======================================================================
      # STEP 4: Detect changed OpenAPI files
      # ======================================================================
      - name: Detect changed OpenAPI specs
        id: changes
        run: |
          echo "ðŸ” Detecting OpenAPI changes..."

          BEFORE="${{ github.event.before }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
            echo "First run detected â€“ taking all OpenAPI specs"
            git ls-files "services/*/*-openapi.y*ml" > changed_files.txt
          else
            git diff --name-status "$BEFORE" "${{ github.sha }}" \
              | awk '$1 != "D" { print $2 }' \
              | grep -E "^services/[^/]+/[^/]+-openapi\.ya?ml$" \
              > changed_files.txt || true
          fi

          if [ ! -s changed_files.txt ]; then
            echo "âŒ No OpenAPI changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… OpenAPI files detected:"
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # ======================================================================
      # STEP 5: Validate OpenAPI specs
      # ======================================================================
      - name: Validate OpenAPI specs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          while IFS= read -r file; do
            echo "ðŸ§ª Validating $file"
            swagger-cli validate "$file"
          done < changed_files.txt

      # ======================================================================
      # STEP 6: Decide FINAL VERSION per OpenAPI spec
      # ======================================================================
      - name: Decide final versions
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "ðŸ”¢ Deciding final versions per OpenAPI spec"
          > version_map.txt

          while IFS= read -r SPEC; do
            echo "âž¡ï¸ Processing $SPEC"

            OLD_VERSION=$(git show ${{ github.event.before }}:"$SPEC" 2>/dev/null \
              | grep -E '^[[:space:]]*version:' | head -1 | sed 's/.*: *//' || true)

            NEW_VERSION=$(grep -E '^[[:space:]]*version:' "$SPEC" \
              | head -1 | sed 's/.*: *//')

            git show ${{ github.event.before }}:"$SPEC" > old.yaml 2>/dev/null || true
            cp "$SPEC" new.yaml

            BUMP="patch"

            if [ -f old.yaml ]; then
              DIFF=$(openapi-diff old.yaml new.yaml || true)

              if echo "$DIFF" | grep -q BREAKING; then
                BUMP="major"
              elif echo "$DIFF" | grep -q ADDED; then
                BUMP="minor"
              fi
            fi

            IFS=. read MAJOR MINOR PATCH <<< "${OLD_VERSION%-SNAPSHOT}"

            case "$BUMP" in
              major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR+1)); PATCH=0 ;;
              patch) PATCH=$((PATCH+1)) ;;
            esac

            FINAL_VERSION="$MAJOR.$MINOR.$PATCH"

            echo "âœ… $SPEC â†’ $FINAL_VERSION ($BUMP)"
            echo "$SPEC=$FINAL_VERSION" >> version_map.txt
          done < changed_files.txt

          echo "ðŸ“„ Version map:"
          cat version_map.txt

      # ======================================================================
      # STEP 7: Generate Java SDKs (version passed explicitly)
      # ======================================================================
      - name: Generate Java SDKs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          find scripts -type f -name "*.sh" -exec chmod +x {} +

          while IFS='=' read -r SPEC VERSION; do
            echo "ðŸš€ Generating SDKs for $SPEC with version $VERSION"
            ./scripts/generate.sh "$SPEC" "$VERSION"
          done < version_map.txt

      # ======================================================================
      # STEP 8: Inject distributionManagement into generated POMs
      # ======================================================================
      - name: Inject Maven distributionManagement
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          for pom in generated/*/*/pom.xml; do
            echo "ðŸ”§ Updating $pom"
            sed -i '/<\/project>/i \
            <distributionManagement>\
              <repository>\
                <id>github</id>\
                <url>https://maven.pkg.github.com/${{ github.repository }}</url>\
              </repository>\
            </distributionManagement>' "$pom"
          done

      # ======================================================================
      # STEP 9: Configure Maven authentication
      # ======================================================================
      - name: Configure Maven settings
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      # ======================================================================
      # STEP 10: Publish SDKs
      # ======================================================================
      - name: Publish SDKs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          for dir in generated/*/*; do
            echo "ðŸ“¦ Publishing $(basename "$dir")"
            cd "$dir"
            mvn deploy -DskipTests
            cd -
          done

      # ======================================================================
      # STEP 11: Summary
      # ======================================================================
      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ Java SDKs Generated & Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat version_map.txt >> $GITHUB_STEP_SUMMARY
