# ============================================================================
# GitHub Actions Workflow: Generate & Publish Java SDKs
#
# Directory Convention:
# services/{service-name}/{service-name}-openapi.yaml
#
# Responsibilities:
# - Detect changed OpenAPI specs
# - Generate Java SDKs (8 / 17 / 21)
# - Apply post-generation fixes via shell scripts
# - Publish artifacts to GitHub Packages
# ============================================================================

name: Generate & Publish Java SDKs

# ----------------------------------------------------------------------------
# Triggers
# ----------------------------------------------------------------------------
on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    # Required for publishing to GitHub Packages
    permissions:
      contents: read
      packages: write

    steps:
      # ======================================================================
      # STEP 1: Checkout repository
      # fetch-depth=2 is REQUIRED for git diff
      # ======================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ======================================================================
      # STEP 2: Setup Java (used for Maven build + deploy)
      # ======================================================================
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      # ======================================================================
      # STEP 3: Install OpenAPI Generator
      # ======================================================================
      - name: Install OpenAPI Generator CLI
        run: |
          npm install -g @openapitools/openapi-generator-cli
          openapi-generator-cli version

      # ======================================================================
      # STEP 4: Detect changed OpenAPI files
      # Produces:
      # - changed_files.txt
      # - has_changes=true|false
      # ======================================================================
      - name: Detect changed OpenAPI specs
        id: changes
        run: |
          echo "ðŸ” Detecting OpenAPI changes..."

          BEFORE="${{ github.event.before }}"

          # First push OR manual run â†’ take all OpenAPI specs
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
            echo "First run detected â€“ taking all OpenAPI specs"
            git ls-files "services/*/*-openapi.y*ml" > changed_files.txt
          else
            git diff --name-status "$BEFORE" "${{ github.sha }}" \
              | awk '$1 != "D" { print $2 }' \
              | grep -E "^services/[^/]+/[^/]+-openapi\.ya?ml$" \
              > changed_files.txt || true
          fi

          if [ ! -s changed_files.txt ]; then
            echo "âŒ No OpenAPI changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… OpenAPI files detected:"
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # ======================================================================
      # STEP 5: Validate OpenAPI specs
      # ======================================================================
      - name: Validate OpenAPI specs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          npm install -g @apidevtools/swagger-cli

          while IFS= read -r file; do
            echo "ðŸ§ª Validating $file"
            swagger-cli validate "$file"
          done < changed_files.txt

      # ======================================================================
      # STEP 6: Generate Java SDKs (delegated to scripts/generate.sh)
      # ======================================================================
      - name: Generate Java SDKs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Safe chmod (avoids CI failures)
          find scripts -type f -name "*.sh" -exec chmod +x {} +

          while IFS= read -r SPEC; do
            echo "ðŸš€ Generating SDKs for $SPEC"
            ./scripts/generate.sh "$SPEC"
          done < changed_files.txt

      # ======================================================================
      # STEP 7: Inject distributionManagement into generated POMs
      # REQUIRED for mvn deploy to GitHub Packages
      # ======================================================================
      - name: Inject Maven distributionManagement
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          for pom in generated/*/*/pom.xml; do
            echo "ðŸ”§ Updating $pom"

            sed -i '/<\/project>/i \
            <distributionManagement>\
              <repository>\
                <id>github</id>\
                <name>GitHub Packages</name>\
                <url>https://maven.pkg.github.com/${{ github.repository }}</url>\
              </repository>\
            </distributionManagement>' "$pom"
          done

      # ======================================================================
      # STEP 8: Configure Maven authentication
      # ======================================================================
      - name: Configure Maven settings
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p ~/.m2

          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      # ======================================================================
      # STEP 9: Publish SDKs to GitHub Packages
      # ======================================================================
      - name: Publish SDKs
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in generated/*/*; do
            echo "ðŸ“¦ Publishing $(basename "$dir")"
            cd "$dir"
            mvn clean deploy -DskipTests
            cd -
          done

      # ======================================================================
      # STEP 10: Summary (GitHub UI)
      # ======================================================================
      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ Java SDKs Generated & Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          while IFS= read -r file; do
            SERVICE=$(basename "$file" | sed 's/-openapi\.ya\?ml//')
            VERSION=$(grep -E '^[[:space:]]*version:' "$file" | head -1 | sed 's/.*: *//')

            echo "### ðŸ“¦ $SERVICE (v$VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- Java 8" >> $GITHUB_STEP_SUMMARY
            echo "- Java 17" >> $GITHUB_STEP_SUMMARY
            echo "- Java 21" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done < changed_files.txt
